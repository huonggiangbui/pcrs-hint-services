# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- develop

variables:

# Azure Resource Manager connection created during pipeline creation
azureSubscription: '2a4e5e9e-69c2-475d-a595-1485c2698c45'

# Web app name
webAppName: 'hintservice-staging'

# Environment name
environmentName: 'Dev'

# Agent VM image name
vmImageName: 'ubuntu-latest'

stages:
- stage: Build
displayName: Build stage
jobs:
- job: Build
    displayName: Build
    pool:
    vmImage: $(vmImageName)

    steps:
    - task: NodeTool@0
    inputs:
        versionSpec: '16.x'
    displayName: 'Install Node.js'

    - script: |
        npm install
        npm run build --if-present
    displayName: 'npm install, build'

    - task: ArchiveFiles@2
    displayName: 'Archive files'
    inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        replaceExistingArchive: true

    - upload: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
    artifact: drop

- stage: Deploy
displayName: Deploy stage
dependsOn: Build
condition: succeeded()
jobs:
- deployment: Deploy
    displayName: Deploy
    environment: $(environmentName)
    pool:
    vmImage: $(vmImageName)
    strategy:
    runOnce:
        deploy:
        steps:
        - task: AzureWebApp@1
            displayName: 'Azure Web App Deploy: sitename'
            inputs:
            azureSubscription: $(azureSubscription)
            appType: webAppLinux
            appName: $(webAppName)
            package: $(Pipeline.Workspace)/drop/$(Build.BuildId).zip
            startUpCommand: 'pm2 start dist/main.js --no-daemon'